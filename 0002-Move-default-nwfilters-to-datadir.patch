From e480e4ecd19deed385fe01773887be25e3a40786 Mon Sep 17 00:00:00 2001
From: Alberto Murillo <alberto.murillo.silva@intel.com>
Date: Fri, 29 Jan 2016 09:45:35 -0600
Subject: [PATCH 2/8] Move default nwfilters to datadir

Signed-off-by: Munoz, Obed N <obed.n.munoz@intel.com>
Signed-off-by: Alberto Murillo <alberto.murillo.silva@intel.com>
Signed-off-by: Simental Magana, Marcos <marcos.simental.magana@intel.com>
---
 examples/Makefile.am           |  2 +-
 src/conf/virnwfilterobj.h      |  1 +
 src/nwfilter/nwfilter_driver.c | 18 +++++++++++-------
 3 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/examples/Makefile.am b/examples/Makefile.am
index ef2f79d..0292a83 100644
--- a/examples/Makefile.am
+++ b/examples/Makefile.am
@@ -88,7 +88,7 @@ templates_DATA = \
 endif WITH_APPARMOR_PROFILES
 
 if WITH_NWFILTER
-NWFILTER_DIR = "$(DESTDIR)$(sysconfdir)/libvirt/nwfilter"
+NWFILTER_DIR = "$(DESTDIR)$(datadir)/libvirt/nwfilter"
 
 install-data-local:
 	$(MKDIR_P) "$(NWFILTER_DIR)"
diff --git a/src/conf/virnwfilterobj.h b/src/conf/virnwfilterobj.h
index 8e79518..c007b35 100644
--- a/src/conf/virnwfilterobj.h
+++ b/src/conf/virnwfilterobj.h
@@ -38,6 +38,7 @@ struct _virNWFilterDriverState {
     virNWFilterObjListPtr nwfilters;
 
     char *configDir;
+    char *defaultsDir;
     bool watchingFirewallD;
 };
 
diff --git a/src/nwfilter/nwfilter_driver.c b/src/nwfilter/nwfilter_driver.c
index 2f9a51c..e310fea 100644
--- a/src/nwfilter/nwfilter_driver.c
+++ b/src/nwfilter/nwfilter_driver.c
@@ -173,7 +173,6 @@ nwfilterStateInitialize(bool privileged,
                         virStateInhibitCallback callback ATTRIBUTE_UNUSED,
                         void *opaque ATTRIBUTE_UNUSED)
 {
-    char *base = NULL;
     DBusConnection *sysbus = NULL;
 
     if (virDBusHasSystemBus() &&
@@ -229,14 +228,17 @@ nwfilterStateInitialize(bool privileged,
         goto error;
     }
 
-    if (VIR_STRDUP(base, SYSCONFDIR "/libvirt") < 0)
+    if (virAsprintf(&driver->configDir,
+                SYSCONFDIR "/libvirt/nwfilter") == -1)
         goto error;
 
-    if (virAsprintf(&driver->configDir,
-                    "%s/nwfilter", base) == -1)
+    if (virNWFilterLoadAllConfigs(&driver->nwfilters,
+                                         driver->configDir) < 0)
         goto error;
 
-    VIR_FREE(base);
+    if (virAsprintf(&driver->defaultsDir,
+                PKGDATADIR "/nwfilter") == -1)
+        goto error;
 
     if (virFileMakePathWithMode(driver->configDir, S_IRWXU) < 0) {
         virReportSystemError(errno, _("cannot create config directory '%s'"),
@@ -247,7 +249,8 @@ nwfilterStateInitialize(bool privileged,
     if (!(driver->nwfilters = virNWFilterObjListNew()))
         goto error;
 
-    if (virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->configDir) < 0)
+    if (virNWFilterLoadAllConfigs(&driver->nwfilters,
+                                 driver->defaultsDir) < 0)
         goto error;
 
     nwfilterDriverUnlock();
@@ -255,7 +258,6 @@ nwfilterStateInitialize(bool privileged,
     return 0;
 
  error:
-    VIR_FREE(base);
     nwfilterDriverUnlock();
     nwfilterStateCleanup();
 
@@ -300,6 +302,7 @@ nwfilterStateReload(void)
     virNWFilterCallbackDriversLock();
 
     virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->configDir);
+    virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->defaultsDir);
 
     virNWFilterCallbackDriversUnlock();
     virNWFilterUnlockFilterUpdates();
@@ -353,6 +356,7 @@ nwfilterStateCleanup(void)
         virNWFilterObjListFree(driver->nwfilters);
 
         VIR_FREE(driver->configDir);
+        VIR_FREE(driver->defaultsDir);
         nwfilterDriverUnlock();
     }
 
-- 
2.15.1


From 2e1bd3a562c606f4ffeb09ee795134475c82d4a7 Mon Sep 17 00:00:00 2001
From: Alberto Murillo <alberto.murillo.silva@intel.com>
Date: Fri, 29 Jan 2016 09:45:35 -0600
Subject: [PATCH 2/8] Move default nwfilters to datadir

Signed-off-by: Munoz, Obed N <obed.n.munoz@intel.com>
Signed-off-by: Alberto Murillo <alberto.murillo.silva@intel.com>

--
update patch to libvirt-4.7.0 release

Signed-off-by: Simental Magana, Marcos <marcos.simental.magana@intel.com>
---
 examples/Makefile.am           |  2 +-
 src/conf/virnwfilterobj.h      |  1 +
 src/nwfilter/nwfilter_driver.c | 11 ++++++++++-
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/examples/Makefile.am b/examples/Makefile.am
index 7069d74..9f0a870 100644
--- a/examples/Makefile.am
+++ b/examples/Makefile.am
@@ -101,7 +101,7 @@ UNINSTALL_LOCAL += uninstall-apparmor-local
 endif WITH_APPARMOR_PROFILES
 
 if WITH_NWFILTER
-NWFILTER_DIR = "$(DESTDIR)$(sysconfdir)/libvirt/nwfilter"
+NWFILTER_DIR = "$(DESTDIR)$(datadir)/libvirt/nwfilter"
 
 install-nwfilter-local:
 	$(MKDIR_P) "$(NWFILTER_DIR)"
diff --git a/src/conf/virnwfilterobj.h b/src/conf/virnwfilterobj.h
index 4a54dd5..0e83387 100644
--- a/src/conf/virnwfilterobj.h
+++ b/src/conf/virnwfilterobj.h
@@ -41,6 +41,7 @@ struct _virNWFilterDriverState {
     virNWFilterBindingObjListPtr bindings;
 
     char *configDir;
+    char *defaultsDir;
     char *bindingDir;
 };
 
diff --git a/src/nwfilter/nwfilter_driver.c b/src/nwfilter/nwfilter_driver.c
index ac3a964..c475e64 100644
--- a/src/nwfilter/nwfilter_driver.c
+++ b/src/nwfilter/nwfilter_driver.c
@@ -240,7 +240,7 @@ nwfilterStateInitialize(bool privileged,
         goto error;
     }
 
-    if (VIR_STRDUP(driver->configDir, SYSCONFDIR "/libvirt/nwfilter") < 0)
+    if (virAsprintf(&driver->configDir, SYSCONFDIR "/libvirt/nwfilter") == -1)
         goto error;
 
     if (virFileMakePathWithMode(driver->configDir, S_IRWXU) < 0) {
@@ -264,6 +264,12 @@ nwfilterStateInitialize(bool privileged,
     if (virNWFilterBindingObjListLoadAllConfigs(driver->bindings, driver->bindingDir) < 0)
         goto error;
 
+    if (virAsprintf(&driver->defaultsDir, PKGDATADIR "/libvirt/nwfilter") == -1)
+        goto error;
+
+    if (virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->defaultsDir) < 0)
+        goto error;
+
     nwfilterDriverUnlock();
 
     return 0;
@@ -314,6 +320,8 @@ nwfilterStateReload(void)
 
     virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->configDir);
 
+    virNWFilterObjListLoadAllConfigs(driver->nwfilters, driver->defaultsDir);
+
     virNWFilterUnlockFilterUpdates();
 
     virNWFilterBuildAll(driver, false);
@@ -347,6 +355,7 @@ nwfilterStateCleanup(void)
         nwfilterDriverRemoveDBusMatches();
 
         VIR_FREE(driver->configDir);
+        VIR_FREE(driver->defaultsDir);
         VIR_FREE(driver->bindingDir);
         nwfilterDriverUnlock();
     }
-- 
2.18.0

